---
title: "SwiftUIã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã‚’ç°¡æ½”ã«æ›¸ã"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - "ios"
  - "swiftui"
published: true
---

# æ¦‚è¦
ç§ã¯SwiftUIã¯Viewã¨ãƒ‡ãƒ¼ã‚¿å±¤ã¯å¯†æ¥ãªé–¢ä¿‚ã«ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ä¾‹ãˆã°Core Dataã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®[FetchRequest](https://developer.apple.com/documentation/swiftui/fetchrequest)ã‚„ã€Viewã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹å€¤ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®[Environment](https://developer.apple.com/documentation/swiftui/environment)ãªã©ã®Property WrapperãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚SwiftUIã§ã¯ã€Property Wrapperã‚’æ´»ç”¨ã—ã¦Viewã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã®å–å¾—å‡¦ç†ã‚’éš è”½ã—ã¤ã¤ã€Viewã§çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ã“ã¨ãŒåŸºæœ¬çš„ãªæ€æƒ³ãªã®ã‹ãªã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

ãã“ã§Rest APIã§ã®ãƒ‡ãƒ¼ã‚¿ã®å–å¾—å‡¦ç†ã‚‚ã€[FetchRequest](https://developer.apple.com/documentation/swiftui/fetchrequest)ã‚„[Environment](https://developer.apple.com/documentation/swiftui/environment)ãªã©ã¨åŒæ§˜ã«Property Wrapperã‚’æ´»ç”¨ã—ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã‹ã¨è€ƒãˆã¾ã—ãŸã€‚

# TL;DR
```
@Get(\.users) var users
```
ã¨å®£è¨€ã—ã€
```
_users.requestUsers()
```
ã‚’ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ãŒå®Œäº†ã™ã‚‹ã€‚

ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ï¼šhttps://github.com/ueshun109/get-request-sample

# ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³
ç§ã¯SwiftUIã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ãŒã€ãã®ã‚¢ãƒ—ãƒªã¯ã„ã‚ã‚†ã‚‹**Jsonè‰²ä»˜ã‘ä¿‚**ã®å´é¢ã‚’å¤§ããæŒã£ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚åŸºæœ¬çš„ã«ã¯ã€**ãƒ‡ãƒ¼ã‚¿ã®å–å¾—**ã¨**UIã®ä½œæˆ**ã®å®Ÿè£…ã‚’ã™ã‚‹ã“ã¨ãŒã»ã¨ã‚“ã©ã§ã™ã€‚ä»¥ä¸‹ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
```swift
import SwiftUI

struct ContentView: View {
  @State private var uiState = UiState()
  private let dataSource: UserDataSource = .mock
  
  var body: some View {
    List {
      ForEach(uiState.users) { user in
        Text(user.firstName)
      }
    }
    .task {
      await fetchUsers()
    }
  }
}

extension ContentView {
  struct UiState {
    var users: [User] = []
  }
}

extension ContentView {
  func fetchUsers() async {
    do {
      uiState.users = try await dataSource.fetchUsers()
    } catch {
      // error handling
    }
  }
}

enum UserDataSource {
    case live

    func fetchUsers() async throws -> [User] {
        // APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å‡¦ç†
        return try await apiClient.requestUsers()
    }
}
```

ä¸Šè¨˜ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªã®ã§ã¾ã è¦‹é€šã—ã¯è‰¯ã„ã§ã™ãŒã€ç§ãŒé–¢ã‚ã£ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ç”»é¢ãŒã‚‚ã†å°‘ã—è¤‡é›‘ã«ãªã£ã¦ãã‚‹ã¨è¦‹é€šã—ãŒæ‚ªããªã£ã¦ãã‚‹ã“ã¨ãŒå¤šã€…ã‚ã‚Šã¾ã—ãŸã€‚ãã®ä¸€å› ãŒ**Viewã®è²¬å‹™ã‹ã‚‰ã¯ã¿å‡ºã¦ã„ã‚‹ã‚‚ã®ãŒå­˜åœ¨ã—ã¦ã„ã‚‹**ã“ã¨ãŒã‚ã‚‹ãŸã‚ã®ã§ã¯ç„¡ã„ã‹ã¨è€ƒãˆã¾ã—ãŸã€‚

ãã“ã§æ°—ã«ãªã£ãŸã®ãŒContentViewã®`fetchUsers`ã§ã™ã€‚
ã“ã®å‡¦ç†ã¯Viewã®è²¬å‹™ã®ç¯„å›²å¤–ã®ã‚ˆã†ã«è¦‹ãˆã¾ã—ãŸã€‚Viewã§ãªã‚‹ã¹ã**ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨**ã ã‘ã«é›†ä¸­ã•ã›ãŸã„ã§ã™ã€‚

ãã“ã§`fetchUsers`ã§è¡Œã£ã¦ã„ã‚‹å‡¦ç†ã‚’[FetchRequest](https://developer.apple.com/documentation/swiftui/fetchrequest)ãªã©ã®SwiftUIã®APIã«ç¿’ã£ã¦Property Wrapperã§è¡Œã†ã“ã¨ãŒã§ãã‚Œã°ã€**ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨**ã«ã‚ˆã‚Šé›†ä¸­ã§ãã‚‹ã®ã§ã¯ãªã„ã‹ã¨è€ƒãˆã¾ã—ãŸã€‚

:::message
ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã‚’è€ƒãˆã‚‹ä¸Šã§ViewModelã®ã‚ˆã†ãªä¸­é–“å±¤ã‚’ç½®ã„ã¦ã‚‚è‰¯ã„ã¨ã¯æ€ã†ã®ã§ã™ãŒã€ç§ã¯SwiftUIã¯Dataã®ãƒã‚¤ãƒ³ãƒ‰ã—ã¦ãã‚Œã‚‹æ©Ÿèƒ½ã‚’å‚™ãˆã¦ã„ã‚‹ãŸã‚ViewModelã‚’è¨­ã‘ã‚‹å¿…è¦ã¯ç„¡ã„ã®ã§ã¯ãªã„ã‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚
:::

# I/F

## Property Wrapper
[FetchRequest](https://developer.apple.com/documentation/swiftui/fetchrequest)ã‚„[Environment](https://developer.apple.com/documentation/swiftui/environment)ãªã©ã¨åŒæ§˜ã«ã€Property Wrapperã‚’ä½¿ã£ã¦çŠ¶æ…‹ã®å–å¾—ã¨çŠ¶æ…‹ã®ä¿æŒã‚’éš è”½ã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚I/Fã¨ã—ã¦ã¯ã€`@Get`ã‚’ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ãƒãƒ¼ã‚¯ã™ã‚‹ã™ã‚‹ã“ã¨ã§ã€çŠ¶æ…‹ã®ä¿æŒã¨å–å¾—å‡¦ç†ã‚’è¡Œã‚ã›ã‚ˆã†ã¨ã—ã¾ã™ã€‚

## KeyPath
I/Fã‚’`@Get`ã¨ã™ã‚‹ã“ã¨ã¯æ±ºå®šã—ã¾ã—ãŸãŒã€å¼•æ•°ã«ã©ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å–å¾—ã™ã‚‹ã‹ã®æƒ…å ±ã‚‚æ¸¡ã—ãŸã„ã§ã™ã€‚ãã—ã¦æ¸¡ã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ã¨ã€ãã“ã‹ã‚‰å–å¾—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å‹ã¯å¯¾å¿œã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠããŸã„ã§ã™ã€‚
ã“ã‚Œã‚’è€ƒãˆã‚‹ä¸Šã§æ³¨ç›®ã—ãŸã®ãŒ[Environment](https://developer.apple.com/documentation/swiftui/environment)ã®I/Fã§ã™ã€‚

[Environment](https://developer.apple.com/documentation/swiftui/environment)ã§ã¯å¼•æ•°ã«KeyPathã‚’æ¸¡ã™I/Fã«ãªã£ã¦ã„ã¾ã™ã€‚KeyPathã‚’æ¸¡ã™ã“ã¨ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒãƒ¼ã‚¯ã•ã‚ŒãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å‹ãŒæ±ºå®šã•ã‚Œã¾ã™ã€‚
```
// var colorScheme: ColorSchemeã¨æ›¸ã‹ãªãã¦ã‚‚æ±ºå®šã•ã‚Œã¦ã„ã‚‹
@Environment(\.colorScheme) var colorScheme
```

ä»Šå›ã¯[Environment](https://developer.apple.com/documentation/swiftui/environment)ã¨åŒæ§˜ãªI/Fã«ã™ã‚Œã°ã‚ˆã„ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã—ãŸã€‚

## APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
Property Wrapperã§çŠ¶æ…‹ã®å–å¾—ã¨ä¿æŒã‚’è¡Œã„ã¾ã™ãŒã€å–å¾—ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ä»»æ„ã«ã—ãŸã„ãŸã‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã®I/Fã‚‚ç”¨æ„ã—ã¾ã™ã€‚

```swift
extension Get {
  /// /v1/songs
  func requestSongs(songDataSource: SongDataSource = .mock) async {}
  
  /// /v1/users
  func requestUsers(userDataSource: UserDataSource = .mock) async {}
}
```

:::message
ã“ã“é–¢ã—ã¦ã¯ç¾çŠ¶è‰¯ã„æ¡ˆãŒç„¡ã„ãŸã‚ã€å°‘ã—é›‘ã«ãªã£ã¦ã„ã¾ã™ã€‚
:::

# å®Ÿè£…
æœ€çµ‚çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã«ãªã‚Šã¾ã—ãŸã€‚

```swift
import SwiftUI

@propertyWrapper
struct Get<Value>: DynamicProperty where Value: Decodable, Value: Equatable {
  var wrappedValue: LoadState<Value> { loadState }

  @State private var loadState: LoadState<Value> = .loading()
  private let keyPath: KeyPath<EndpointValues, Value>
  private let defaultValue: Value?

  init(
    _ keyPath: KeyPath<EndpointValues, Value>,
    _ defaultValue: Value? = nil
  ) {
    self.keyPath = keyPath
    self.defaultValue = defaultValue
    if let defaultValue = defaultValue {
      _loadState = .init(initialValue: .loading(skelton: defaultValue))
    }
  }
}

extension Get {
  struct EndpointValues {
    /// /v1/users
    @Lateinit var users: [User]
    /// /v1/songs
    @Lateinit var songs: [Song]
  }
}

extension Get {
  /// /v1/songs
  func requestSongs(songDataSource: SongDataSource = .live) async {
    // ä»»æ„ã®å‡¦ç†
  }
  
  /// /v1/users
  func requestUsers(userDataSource: UserDataSource = .live) async {
    // ä»»æ„ã®å‡¦ç†
  }
}
```

# èª²é¡Œ
ä¸Šè¨˜ã®å®Ÿè£…ã ã¨ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾å¿œã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã‚’å¼·åˆ¶ã§ããªã„ã“ã¨ã§ã™ã€‚
ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«`users`ã§`requestSongs`ã‚’å®Ÿè¡Œã§ãã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã‚Œã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã§ã™ã€‚

```
@Get(\.users) private var users
_users.requestSongs()
```

:::message
å›é¿ç­–ã¨ã—ã¦å®Ÿéš›ã«ä¸Šè¨˜ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`@Lateinit`ã¨ã„ã†è‡ªä½œã—ãŸProperty Wrapperã§fatal errorãŒç™ºç”Ÿã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
:::

# å¾Œã‹ã‚‰æ°—ã¥ã„ãŸã“ã¨
:::message alert
ä»Šå›ã®Property Wrapperã‚’ä½œæˆã—ãŸå¾Œã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã«[ObservableObject](https://developer.apple.com/documentation/combine/observableobject)&[StateObject](https://developer.apple.com/documentation/swiftui/stateobject)ã§å®Ÿè£…ã—ã¦ã„ã‚‹ã®ã¨ä½•ã‚‚å¤‰ã‚ã‚‰ã‚“ã‚„ã‚“ã€ã¨æ€ã„ã¾ã—ãŸã€‚
è‹¥å¹²å¯èª­æ€§ã¯é«˜ããªã‚‹ã®ã‹ãªã¨ã‚‚æ€ã„ã¾ã—ãŸãŒã€æ¨™æº–ã®APIã‚’ä½¿ã£ãŸã»ã†ãŒå®‰å¿ƒæ„Ÿã‚ã‚Šåƒ•ã¯ãã®æ–¹ãŒå¥½ã¿ãªã®ã§ã€ä»Šå›è‡ªä½œã—ãŸPropertyWrapperã¯ä½¿ã‚ãšã«ObservableObject & StateObjectã§å®Ÿè£…ã™ã‚‹æ–¹é‡ã«ã—ã¦ã„ã¾ã™ã€‚
:::

```swift
@MainActor
final class UserState: ObservableObject {
  @Published private(set) var users: LoadState<[User]>

  func fetchUsers() async { ... }
}

struct ContentView: View {
  @StateObject private var userState: UserState = .init()

  var body: some View {
    Group {
      switch userState.users {
      case .success(let users):
        // æˆåŠŸæ™‚ã®View
      case .loading(let users):
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®View 
      case .failure(let error):
        // å¤±æ•—æ™‚ã®View
      }
    }
    .task {
      await userState.fetchUsers()
    }
  }
}
```