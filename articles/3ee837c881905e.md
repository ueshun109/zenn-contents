---
title: "[SwiftUI] Viewã«ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆã‚’å½“ã¦ã‚‹"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [iOS, SwiftUI]
published: true
---

# æ¦‚è¦

ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆã¨ã¯ã€ã‚¢ãƒ—ãƒªã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãªã©ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¬¡ã®è¡Œå‹•ã‚’ä¿ƒã™ãŸã‚ã«ãƒœã‚¿ãƒ³ãªã©ç‰¹å®šã® View ã‚’ç›®ç«‹ãŸã›ã‚‹æ‰‹æ³•ã®ã“ã¨ã‚’æŒ‡ã—ã¾ã™ã€‚
æœ¬è¨˜äº‹ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãª UI ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

![](/images/3ee837c881905e/result2.gif =250x)

ã“ã‚Œã‚’å®Ÿè£…ã™ã‚‹ã«ã¯ã€å¤§ããä»¥ä¸‹ï¼“ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå¿…è¦ã§ã™ã€‚

1. ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆã‚’å½“ã¦ã‚‹ View ã®åº§æ¨™ã¨å¯¸æ³•ã‚’å–å¾—
1. ç”»é¢å…¨ä½“ã‚’ã¼ã‹ã™
1. View ã‚’åˆ‡ã‚ŠæŠœã

::: message
[Youtube](https://www.youtube.com/watch?v=CLjfUN4gTYQ)ã§ç´¹ä»‹ã•ã‚Œã¦ã„ãŸæ–¹æ³•ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ã¦ãŠã‚Šã€æœ¬ç¨¿ã§ã¯ã‚³ãƒ¼ãƒ‰ã®è§£èª¬ã‚’ãƒ¡ã‚¤ãƒ³ã«è¡Œã£ã¦ã„ã¾ã™ã€‚
:::

æœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰ã¯ GitHub ã«æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚
https://github.com/ueshun109/SwiftUIStylebook/blob/main/SwiftUIStylebook/UIComponents/SpotlightView.swift

# åº§æ¨™ã¨å¯¸æ³•ã‚’å–å¾—

SwiftUI ã«ã¯ã€å­ãƒ“ãƒ¥ãƒ¼ï¼ˆSubviewsï¼‰ã‹ã‚‰è¦ªãƒ“ãƒ¥ãƒ¼(Container)ã«å€¤ã‚’æ¸¡ã™ãŸã‚ã«ã€[Preferences](https://developer.apple.com/documentation/swiftui/preferences)ã¨ã„ã†ä»•çµ„ã¿ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã‚Œã‚’ä½¿ã£ã¦ã€ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆã‚’å½“ã¦ãŸã„ View ã®åº§æ¨™ã‚’è¦ªãƒ“ãƒ¥ãƒ¼ã«é€ä¿¡ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

```swift
struct SpotlightBoundsKey: PreferenceKey {
  typealias ID = Int

  static var defaultValue: [ID: Anchor<CGRect>] = [:]

  static func reduce(
    value: inout [ID: Anchor<CGRect>],
    nextValue: () -> [ID: Anchor<CGRect>]
  ) {
    value.merge(nextValue()) { $1 }
  }
}
```

`reduce`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€`inout`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã¤ã„ãŸ`value`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°ã—ã¦ã„ãã¾ã™ã€‚
ä»Šå›ã¯ã€`SpotlightBoundsKey`ã‚’æŒ‡å®šã—ãŸ View ã®åº§æ¨™ã‚’è“„ç©ã—ã¦ã„ããŸã„ä¸”ã¤ ID ãŒé‡è¤‡ã—ãŸå ´åˆæ–°ã—ã„å€¤ã‚’å„ªå…ˆã—ãŸã„ãŸã‚ã€`merge` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

æ¬¡ã«ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆã‚’å½“ã¦ãŸã„ View ã®åº§æ¨™ãƒ»å¯¸æ³•ã‚’ã€PreferenceKey ã«è“„ç©ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã‚’ç”¨æ„ã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€[anchorPreference](<https://developer.apple.com/documentation/swiftui/view/anchorpreference(key:value:transform:)>)ã‚’æŒ‡å®šã—ã¦ View ã®åº§æ¨™ãƒ»å¯¸æ³•ã‚’`SpotlightBoundsKey`ã®å€¤ã«è“„ç©ã—ã¾ã™ã€‚

```swift
extension View {
  func spotlightAnchor(at id: SpotlightBoundsKey.ID) -> some View {
    self.anchorPreference(key: SpotlightBoundsKey.self, value: .bounds) { [id: $0] }
  }
}
```

# ç”»é¢å…¨ä½“ã‚’ã¼ã‹ã™

ç”»é¢å…¨ä½“ã‚’ã¼ã‹ã™ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã¼ã‹ã—ãŸè‰²ã® View ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã™ã‚‹ã ã‘ã§ã™ã€‚

```swift
struct SpotlightModifier: ViewModifier {
  func body(content: Content) -> some View {
    content
      .overlay {
        Rectangle()
          .fill(.ultraThinMaterial)
          .environment(\.colorScheme, .dark)
          .ignoresSafeArea()
      }
  }
}
```

ã—ã‹ã—ã“ã‚Œã§ã¯ã€ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆã‚’å½“ã¦ã‚‹ãŸã‚ã«å¿…è¦ãªã€åº§æ¨™ãƒ»å¯¸æ³•ã‚’å‚ç…§ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
ãã“ã§[overlayPreferenceValue](<https://developer.apple.com/documentation/swiftui/view/overlaypreferencevalue(_:_:)>)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
`overlayPreferenceValue`ã¯`PreferenceKey`ã‚’ç”¨ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã€ãã‚Œã«åŸºã¥ã„ãŸ View ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚
ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ç”»é¢å…¨ä½“ã‚’ã¼ã‹ã—ãŸ View ã§è¦†ã†ä¸”ã¤ã€Preferences ã§è“„ç©ã—ãŸåº§æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```diff swift
- .overlay {
+ .overlayPreferenceValue(SpotlightBoundsKey.self) { values in // valuesãŒè“„ç©ã—ãŸåº§æ¨™ãƒ»å¯¸æ³•ã®æƒ…å ±ã‚’æŒã£ã¦ã„ã‚‹
```

# ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆã‚’ã‚ã¦ã‚‹

æœ€å¾Œã«ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆã‚’å½“ã¦ã‚‹å‡¦ç†ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

## åº§æ¨™ãƒ»å¯¸æ³•ã‚’å–ã‚Šå‡ºã™

ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆã‚’å½“ã¦ãŸã„ View ã®`CGRect`ã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã‚Œã¯`GeometryProxy`ã®[subscript](<https://developer.apple.com/documentation/swiftui/geometryproxy/subscript(_:)>)ã‚’ä½¿ã†ã“ã¨ã§ã€`Anchor`ã®`Value`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```diff swift
.overlayPreferenceValue(SpotlightBoundsKey.self) {
- Rectangle()
-   .fill(.ultraThinMaterial)
-   .environment(\.colorScheme, .dark)
-   .ignoresSafeArea()
+  GeometryReader { proxy in
+    let preference = values.first(where: { $0.key == spotlightingID })
+     if let preference {
+       let rect = proxy[preference.value]
+       Rectangle()
+         .fill(.ultraThinMaterial)
+         .environment(\.colorScheme, .dark)
+     }
+   }
+   .ignoresSafeArea()
}
```

## åˆ‡ã‚ŠæŠœã

ã¼ã‹ã—ãŸ View ã®ä¸€éƒ¨ã‚’åˆ‡ã‚ŠæŠœãã“ã¨ã§ã€ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆãŒå½“ãŸã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ã›ã¦ã„ãã¾ã™ã€‚
æŒ‡å®šã—ãŸå½¢ã§ View ã®ä¸€éƒ¨ã‚’åˆ‡ã‚ŠæŠœããŸã‚ã€[mask](<https://developer.apple.com/documentation/swiftui/view/mask(alignment:_:)>)ã¨[blendMode](<https://developer.apple.com/documentation/swiftui/view/blendmode(_:)>)ã‚’ä½¿ã£ã¦ãƒªãƒãƒ¼ã‚¹ãƒã‚¹ã‚¯ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

:::message
ãƒªãƒãƒ¼ã‚¹ãƒã‚¹ã‚¯ã¨ã¯ã€ãƒã‚¹ã‚¯ã•ã‚ŒãŸã‚¨ãƒªã‚¢ã‚’é€æ˜åŒ–ã—ï¼ˆåˆ‡ã‚ŠæŠœãï¼‰ã€ãã®ã‚¨ãƒªã‚¢ä»¥å¤–ã®éƒ¨åˆ†ã‚’è¡¨ç¤ºã•ã›ã‚‹ã“ã¨ã§ã€èƒŒæ™¯ã‚„ä¸‹å±¤ã«ã‚ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éœ²å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚
:::

```diff swift
extension View {
+  func reverseMask<Content: View>(alignment: Alignment, = .center, _ content: () -> Content) -> some View {
+    self.mask {
+      Rectangle()
+        .overlay(alignment: alignment) {
+          content()
+            .blendMode(.destinationOut)
+        }
+    }
+  }
}
```

`blendMode`ã¯é‡ãªã‚Šåˆã£ãŸ View ã‚’çµåˆã—ã€è‰²ã‚„è¼åº¦ãªã©ã‚’èª¿æ•´æ§˜ã€…ãªè¦–è¦šåŠ¹æœã‚’ä½¿ç”¨ã—ãŸ View ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
`destinationOut`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ã‚½ãƒ¼ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è‰²ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ã‚¹ãƒ†ã‚£ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰è‰²ã‚’æ¶ˆå»ã—ã¦ã„ã¾ã™ã€‚

ã‚ã¨ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«`reverseMask`ã‚’æŒ‡å®šã™ã‚Œã°ã€ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆãŒå½“ãŸã£ã¦ã„ã‚‹ã‚ˆã†ãªè¦–è¦šåŠ¹æœãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

```diff swift
Rectangle()
  .fill(.ultraThinMaterial)
  .environment(\.colorScheme, .dark)
+ .reverseMask(alignment: .topLeading) {
+   RoundedRectangle(cornerRadius: 8)
+     .frame(width: rect.width, height: rect.height)
+     .offset(x: rect.minX, y: rect.minY)
+ }
```

![](/images/3ee837c881905e/result1.png =250x)

:::details Preview code

```swift
#Preview {
  HStack(spacing: 24) {
    Spacer()
    Image(systemName: "lightbulb.fill")
      .resizable()
      .scaledToFit()
      .frame(width: 100, height: 100)
      .padding()
      .spotlightAnchor(at: 1)

    Image(systemName: "lightbulb.max.fill")
      .resizable()
      .scaledToFit()
      .frame(width: 100, height: 100)
      .padding()
    Spacer()
  }
  .frame(maxWidth: .infinity, maxHeight: .infinity)
  .spotlight(enable: .constant(true), spotlightingID: .constant(1))
}
```

:::

# ãã®ä»–

ã“ã“ã¾ã§ã®å†…å®¹ã§ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆãŒå½“ãŸã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ã›ã‚‹ã“ã¨ã¯ã§ããŸã®ã§ã™ãŒã€ã“ã‚Œã ã‘ã§ã¯ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã¨ã—ã¦ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã®ã¯é›£ã—ã„ã¨æ€ã„ã¾ã™ã€‚ãã“ã§ä»¥ä¸‹ã®å‡¦ç†ã‚‚è¿½åŠ ã§å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

- ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨åˆ¥ã® View ã«ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆãŒã‚ãŸã‚‹
- ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹éš›ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹

```diff swift
struct SpotlightModifier: ViewModifier {
+  @Binding var enable: Bool
+  @Binding var spotlightingID: SpotlightBoundsKey.ID

  func body(content: Content) -> some View {
    content
      .overlayPreferenceValue(SpotlightBoundsKey.self) { values in
        GeometryReader { proxy in
          let preference = values.first(where: { $0.key == spotlightingID })
          if let preference {
            let rect = proxy[preference.value]
            Rectangle()
              .fill(.ultraThinMaterial)
              .environment(\.colorScheme, .dark)
+             .opacity(enable ? 1 : 0)  // ç„¡åŠ¹ã®å ´åˆã¯ã¼ã‹ã•ãªã„ã‚ˆã†ã«ã™ã‚‹
              .reverseMask(alignment: .topLeading) {
                RoundedRectangle(cornerRadius: 8)
                  .frame(width: rect.width, height: rect.height)
                  .offset(x: rect.minX, y: rect.minY)
              }
+             .onTapGesture {
+               if spotlightingID <= values.count {
+                 spotlightingID += 1
+               } else {
+                 enable = false
+               }
+             }
          }
        }
        .ignoresSafeArea()
+       .animation(.easeInOut, value: enable)
+       .animation(.easeInOut, value: spotlightingID)
      }
  }
}
```

# ã¾ã¨ã‚

ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆã‚’å½“ã¦ã‚‹ãŸã‚ã®å®Ÿè£…ã®ã‚„ã‚Šæ–¹ã¯è‰²ã€…ã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒã€æœ¬ç¨¿ã§ã¯ä¸»ã«ä»¥ä¸‹ï¼“ã¤ã®æ©Ÿèƒ½ã‚’ç”¨ã„ã¦å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚

- PreferenceKey
- mask
- blendMode

# å‚è€ƒ URL

- https://www.youtube.com/watch?v=CLjfUN4gTYQ
- https://dev.classmethod.jp/articles/swiftui-reverse-mask/
