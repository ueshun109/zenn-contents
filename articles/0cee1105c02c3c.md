---
title: "iOSé–‹ç™ºã§ã‚‚æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã‚’æ¤œçŸ¥ã—ãŸã„"
emoji: "ğŸ”"
type: "tech"
topics:
  - "ios"
  - "bitrise"
  - "periphery"
published: true
published_at: "2021-01-06 13:23"
---

## æ¦‚è¦
ã©ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚ã©ã“ã‹ã‚‰ã‚‚å‚ç…§ã•ã‚Œã¦ã„ãªã„ã‚³ãƒ¼ãƒ‰ãŒï¼‘ã¤ã‚„ï¼’ã¤ã‚ã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
ãã—ã¦ã“ã®æ•°ãŒå¢—ãˆã‚‹ã«ã¤ã‚Œãƒã‚¤ã‚ºãŒå¤šããªã‚‹ã®ã§ã€è¦‹ãŸã„ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¥ã‚‰ããªã‚‹ã®ã§é–‹ç™ºã®åŠ¹ç‡ãŒè½ã¡ã¦ã—ã¾ã„ã¾ã™ã€‚

:::message
ãã‚‚ãã‚‚å®Ÿè£…è€…ãŒä½¿ç”¨ã—ã¦ã„ãªã„ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãªã€ã¨æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒå®Ÿè£…è€…ã‚‚äººãªã®ã§æ°—ã¥ã‹ãšã«ã‚³ãƒŸãƒƒãƒˆã—ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚‚æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã«æ°—ã¥ã‹ãšã«Approveã—ã¦ã—ã¾ã†ã“ã¨ã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
:::

ãã“ã§æœ¬è¨˜äº‹ã§ã¯Peripheryã¨ã„ã†CLIãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç”¨ã„ã¦æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã‚’æ¤œçŸ¥ã™ã‚‹æ–¹æ³•ã¨ã€CIãƒ“ãƒ«ãƒ‰ã«ãŠã„ã¦æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Œã°Pull Requestã«æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ç®‡æ‰€ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹æ–¹æ³•ã‚’è¿°ã¹ã¦ã„ãã¾ã™ã€‚

## ä½¿ç”¨ã™ã‚‹CLIãƒ„ãƒ¼ãƒ«
- mint (Swiftè£½ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«. ä»Šå›ã¯èª¬æ˜ã‚’çœç•¥ã—ã¾ã™.)
- Periphery
- Danger

## Periphery
Peripheryã¨ã¯ã€æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã‚’åˆ†æã™ã‚‹Swiftè£½ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

https://github.com/peripheryapp/periphery

## Peripheryã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
:::message
Peripheryã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã¯è¤‡æ•°ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯[Mint](https://github.com/yonaskolb/Mint)ã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
:::
ï¼‘. `Mintfile`ã‚’ç”Ÿæˆã—ã€ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚
```
peripheryapp/periphery@2.3.1
```
ï¼’. `mint bootstrap`ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

## Danger
Dangerã¯ã€Pull Requestã«å¯¾ã—ã¦äº‹å‰ã«æ±ºã‚ãŸãƒ«ãƒ¼ãƒ«ã«å‰‡ã£ã¦Auto Reviewã—ã¦ãã‚Œã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
äº‹å‰ã«æ±ºã‚ãŸãƒ«ãƒ¼ãƒ«ã¨ã¯ã€ã€ŒPull Requestã®å·®åˆ†ã¯500ã¾ã§ã€ã‚„ã€ŒLintã®ãƒ«ãƒ¼ãƒ«ã«å‰‡ã£ã¦ã„ã‚‹ã‹ã€ãªã©ã§ã™ã€‚

### Dangerã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
ï¼‘. bundlerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹(å¿…é ˆã§ã¯ãªã„ãŒã€bundlerã‚’ä½¿ã£ãŸã»ã†ãŒç®¡ç†ã—ã‚„ã™ã„ã€‚)  
```
gem install bundler
```
ï¼’. Gemfileã‚’ç”Ÿæˆã™ã‚‹
```
bundle init
```
ï¼“. Gemfileã«ä»¥ä¸‹ã‚’è¿½è¨˜ã™ã‚‹
```
gem "danger"
```
ï¼”. Dangerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
```
bundle install --path .bundle/
```
:::message
`.bundle/`ã¯.gitignoreã«è¿½è¨˜ã—ã¦gitç®¡ç†ã—ãªã„ã»ã†ãŒè‰¯ã„ã§ã™ã€‚
:::
ï¼•ï¼ Gemfileã¨Gemfile.lockã‚’ã‚³ãƒŸãƒƒãƒˆã™ã‚‹

ï¼–. [Dangerå…¬å¼ãƒšãƒ¼ã‚¸](https://danger.systems/guides/getting_started.html)ã‚’å‚è€ƒã«Pull Requestã«Botãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚³ãƒ¡ãƒ³ãƒˆã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

## æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã‚’åˆ†æã™ã‚‹
ç§ã¯ä»¥ä¸‹ï¼’ã¤ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¦Peripheryã‚’å®Ÿè¡Œã—ã€ãã®çµæœã‚’è§£æã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
``` sh:run_unused_code.sh
DIR="report"
if [ ! -d $DIR ]; then
  mkdir $DIR
fi

mint run periphery scan --project xxx.xcodeproj --targets ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå --schemes ã‚¹ã‚­ãƒ¼ãƒ å --format "xcode" > report/unused_code_report.txt
```

``` ruby:parse_unused_code_report.rb
Dir.mkdir('report') unless Dir.exist?('report')

system('bash Scripts/Bitrise/run_unused_code.sh')

warnings = []

File.open('report/unused_code_report.txt', mode = 'rt') do |f|
  f.each_line(rs='') do |line|
    warnings.push(line.chomp(rs='')) 
  end
end

File.open('report/parsed_unused_code_report.txt', mode = 'w') do |f|
  f.write(warnings[1])
end
```

Dangerfileã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

``` ruby: Dangerfile
File.open("report/parsed_unused_code_report.txt").each do |warnings|
  warnings.split("\n").each do |warning|
    warn(warning)
  end
end
```

ã‚ã¨ã¯CIãƒ“ãƒ«ãƒ‰ã§ä¸Šè¨˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ä»Šå›ã¯Bitriseã§ã®å®Ÿè¡Œã‚’æƒ³å®šã—ã¦ã„ã‚‹ã®ã§ã€bitrise.ymlã«ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```yml
steps:
- script@1:
    inputs:
    - content: |-
        gem install bundler
        bundle config set path '.bundle/'
        bundle install
    title: Bundle install
- script@1:
    inputs:
    - content: 'ruby parse_unused_code_report.rb '
    title: Output unused code
- script@1:
    inputs:
    - content: bundle exec danger --verbose
    title: Run danger
```

 ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã¨Pull Requestã«ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã‚Œã¾ã™ã€‚
 ![](https://storage.googleapis.com/zenn-user-upload/qlpk4o0xppgj3eji55i8nyanjmgr)

## ã¾ã¨ã‚
ç°¡å˜ã«æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã‚’æ¤œçŸ¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€æ˜¯éå°å…¥ã—ã¦ã¿ã¦ãã ã•ã„ï¼